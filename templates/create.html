<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import PDF Study Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card-preview { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 8px; }
        .loading { display: none; color: #60a5fa; }
        body { background-color: #111827; min-height: 100vh; }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="text-white p-6">
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-[1fr_350px] gap-8">
        
        <!-- LEFT COLUMN: EDITOR -->
        <div class="space-y-6">
            <div class="bg-gray-800/50 p-6 rounded-xl border border-white/10">
                <input id="deckTitle" type="text" placeholder="Title" class="text-3xl font-bold bg-transparent border-none focus:ring-0 w-full mb-2 placeholder:text-gray-500">
                <textarea id="deckDescription" placeholder="Add a description..." class="bg-transparent border-none focus:ring-0 w-full text-gray-300 resize-none h-12 placeholder:text-gray-500"></textarea>
                <hr class="border-white/10 my-4">
                
                <div id="cardsContainer" class="space-y-4">
                    <!-- Dynamic cards will appear here -->
                </div>

                <div class="mt-8 flex gap-4">
                    <button id="addCardBtn" class="flex-1 py-4 border-2 border-dashed border-white/20 rounded-xl hover:border-white/40 hover:bg-white/5 transition-all text-gray-400 font-medium">
                        + Add New Card
                    </button>
                    <button id="saveDeckBtn" class="px-8 py-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold shadow-lg shadow-blue-900/20 transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                        Save Deck
                    </button>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: UPLOAD & CONTROLS -->
        <div class="space-y-6 h-full">
            <div id="upload" class="bg-gray-800 p-6 rounded-xl border border-white/10 sticky top-6">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    Import Quizlet PDF
                </h2>
                
                <form id="uploadForm" class="space-y-4">
                    <div class="relative group">
                        <label for="pdfFile" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-600 rounded-lg cursor-pointer bg-gray-700/30 hover:bg-gray-700/50 transition-all group-hover:border-blue-500">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <p id="fileNameDisplay" class="mb-2 text-sm text-gray-400 text-center px-2">Click to upload PDF</p>
                            </div>
                            <input type="file" id="pdfFile" name="file" accept=".pdf" class="hidden">
                        </label>
                    </div>

                    
                    
                    <button type="submit" class="w-full bg-white text-black font-bold py-3 rounded-lg hover:bg-gray-200 transition-colors">
                        Process PDF
                    </button>
                </form>

                <div id="loading" class="loading mt-4 text-center">
                    <div class="animate-spin inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full mb-1" role="status"></div>
                    <p class="text-sm font-medium" id="loadingText">Processing PDF...</p>
                </div>

                <div id="statusMessage" class="mt-4 p-3 rounded-lg text-sm hidden text-center"></div>
            </div>
            <div id="AI" class="bg-gray-800 p-6 rounded-xl border sticky border-white/10 top-6">
                <h1 class="text-xl font-bold mb-3">Create With Ai</h1>
                <textarea id="Ai-message" placeholder="Describe what content you want" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-sm focus:outline-none focus:border-blue-500"></textarea>
                <input type="number" min="0" max="20" id="target" placeholder="target amount cards (max of 20)" class="w-full bg-gray-900 mb-3 border border-gray-700 rounded-lg p-3 text-sm focus:outline-none focus:border-blue-500">
                <br>
                <button onclick="createwithai()" class="w-full bg-gradient-to-r from-[#4285F4] via-[#9b72cb] to-[#d96570] text-white font-bold py-3 rounded-lg hover:opacity-90 transition-all shadow-lg hover:shadow-indigo-500/40">
                    Create
                </button>
                <div id="aiStatusMessage" style="display: none;" class="mt-4 p-3 rounded-lg text-sm bg-green-900/30 text-green-400"></div>
            </div>
        </div>
    </div>

    <script>
setInterval(function(){
const uploadDiv = document.getElementById('upload');
const aiDiv = document.getElementById('AI');
const offset = uploadDiv.offsetHeight + 60;
aiDiv.style.top = offset + 'px';
}, 200)
        let editsave = false;
        let cardCount = 0;
        function setaistatus(message, time=null){
            const ele = document.getElementById('aiStatusMessage')
            ele.innerText = message
            ele.style.display = 'block'
            if (time){
                setTimeout(function(){
                    ele.style.display = 'none'
                }, time)
            }
        }
        async function createwithai(){
            const message = document.getElementById('Ai-message')
            const target = document.getElementById('target')
            setaistatus('Creating your set...')
            await fetch(`/api/createwithai?message=${message.value}&target=${target.value}`).then(res => res.json()).then(data => {
                data.forEach(card => {
                    createCard(term=card.question, definition=card.answer)
                })
            }).catch(err => console.error("Error:", err));
            setaistatus('DONE!', time=2000)
            message.value = ''
            target.value = 0
        }
        function fileToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        const par = new URLSearchParams(window.location.search)
        const edit = par.get('edit')
        if (edit){
            let data;
            fetch(`/api/cards?set=${edit}`).then(res => res.json()).then(resdata => data = resdata).then(res => {
                document.getElementById('deckTitle').value = data['Title']
                document.getElementById('deckDescription').textContent = data['description']
                data['content'].forEach(obj =>{
                createCard(obj.question, obj.answer, obj.image || null)
            })
            editsave = true
                    if(!editsave){
            for(let i=0; i<2; i++) createCard();
        }
        })
        }
        async function handleImageUpload(input, previewId) {
            const file = input.files[0];
            const previewImg = document.getElementById(previewId);
            const cardEl = input.closest('.card-item');
            
            if (file) {
                try {
                    const dataUrl = await fileToDataUrl(file);
                    previewImg.src = dataUrl;
                    previewImg.classList.remove('hidden');
                    cardEl.dataset.imageUrl = dataUrl;
                } catch (err) {
                    console.error("Image conversion failed", err);
                    showMessage("Failed to process image", true);
                }
            } else {
                previewImg.src = "";
                previewImg.classList.add('hidden');
                delete cardEl.dataset.imageUrl;
            }
        }

        function createCard(term = '', definition = '', existingImage = null) {
            cardCount++;
            const cardId = `card-${Date.now()}-${cardCount}`;
            const previewId = `preview-${cardId}`;
            
            const cardHtml = `
                <div id="${cardId}" class="card-item w-full p-6 bg-gray-800/80 rounded-xl border border-white/5 hover:border-white/20 transition-all group" data-image-url="${existingImage || ''}">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-sm font-bold text-gray-500 group-hover:text-blue-400 transition-colors tracking-widest uppercase">Card #${cardCount}</span>
                        <button onclick="removeCard('${cardId}')" class="text-gray-600 hover:text-red-400 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-[1fr_1fr_120px] gap-6 items-start">
                        <div class="space-y-2">
                            <label class="text-xs font-semibold text-gray-400 uppercase">Term</label>
                            <input type="text" value="${term}" placeholder="Enter term..." class="term-input w-full bg-gray-900/50 border border-gray-700 rounded-lg p-3 focus:border-blue-500 focus:outline-none transition-colors">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-semibold text-gray-400 uppercase">Definition</label>
                            <textarea placeholder="Enter definition..." class="definition-input w-full bg-gray-900/50 border border-gray-700 rounded-lg p-3 focus:border-blue-500 focus:outline-none transition-colors resize-none h-[46px]">${definition}</textarea>
                        </div>
                        <div class="space-y-2 flex flex-col items-center">
                            <label class="text-xs font-semibold text-gray-400 uppercase mb-1">Image</label>
                            <label class="cursor-pointer bg-gray-700 p-2 rounded-lg hover:bg-gray-600 transition-colors border border-gray-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                                <input type="file" accept="image/*" class="hidden" onchange="handleImageUpload(this, '${previewId}')">
                            </label>
                            <img id="${previewId}" src="${existingImage || ''}" class="${existingImage ? '' : 'hidden'} w-full h-12 object-cover rounded-md mt-2 border border-gray-600">
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('cardsContainer').insertAdjacentHTML('beforeend', cardHtml);
            updateCardIndices();
        }

        function removeCard(id) {
            document.getElementById(id).remove();
            updateCardIndices();
        }

        function updateCardIndices() {
            const cards = document.querySelectorAll('.card-item');
            cardCount = cards.length;
            cards.forEach((card, index) => {
                card.querySelector('span').innerText = `Card #${index + 1}`;
            });
        }

        function showMessage(msg, isError = false) {
            const el = document.getElementById('statusMessage');
            el.innerText = msg;
            el.className = `mt-4 p-3 rounded-lg text-sm ${isError ? 'bg-red-900/30 text-red-400' : 'bg-green-900/30 text-green-400'}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }


        document.getElementById('pdfFile').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || "Click to upload PDF";
            document.getElementById('fileNameDisplay').innerText = fileName;
        });

        document.getElementById('addCardBtn').addEventListener('click', () => createCard());

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('pdfFile');
            if (!fileInput.files[0]) return showMessage("Please select a file first", true);

            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            loading.style.display = 'block';
            let data;
            const formData = new FormData(document.getElementById('uploadForm'))
            try {
                loadingText.innerText = "Parsing PDF...";
                await fetch('/api/parse-pdf', {
                    method : "POST",
                    body : formData
                }).then(res => res.json()).then(resdata => data = resdata)
                data[0].content.forEach(obj => {
                    createCard(obj.question, obj.answer, obj.image);
                })

                loadingText.innerText = "Populating editor...";
                showMessage(`Successfully imported ${data[0].content.length} cards!`);
            } catch (err) {
                showMessage(err.message, true);
            } finally {
                loading.style.display = 'none';
                fileInput.value = '';
                document.getElementById('fileNameDisplay').innerText = "Click to upload PDF";
            }
        });

        document.getElementById('saveDeckBtn').addEventListener('click', async () => {
            const title = document.getElementById('deckTitle').value.trim();
            const description = document.getElementById('deckDescription').value.trim();
            const cards = [];
            
            document.querySelectorAll('.card-item').forEach(cardEl => {
                const question = cardEl.querySelector('.term-input').value.trim();
                const answer = cardEl.querySelector('.definition-input').value.trim();
                const image = cardEl.dataset.imageUrl || null;

                if (question || answer) {
                    cards.push({ 
                        question, 
                        answer, 
                        image 
                    });
                }
            });

            if (!title) return showMessage("Please enter a title for your deck", true);
            if (cards.length === 0) return showMessage("Add at least one card before saving", true);

            const deckData = {
                "Title": title,
                "cards": cards.length,
                "content": cards,
                "description": description
            };

            console.log("Saving Deck with Images:", deckData);
            
            const btn = document.getElementById('saveDeckBtn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = "Saving...";
            btn.disabled = true;
            if (editsave){
                            try {
                const res = await fetch(`/import?set=${title}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(deckData)
                });
                
                if(!res.ok) throw new Error("Server responded with error");
                
                showMessage(`Deck "${title}" with ${cards.length} cards, saved successfully!`);
            } catch (err) {
                showMessage(`Error saving ${title}, ${err}`);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
            }
            else{

            try {
                const res = await fetch(`/import`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(deckData)
                });
                
                if(!res.ok) throw new Error("Server responded with error");
                
                showMessage(`Deck "${title}" with ${cards.length} cards, saved successfully!`);
            } catch (err) {
                showMessage(`Error saving ${title}, ${err}`);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }
        });
    
    </script>
</body>
</html>
<html>
    <head>
        <title>Quiz Cards</title>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="grid place-items-center grid-cols-3 grid-rows-3 bg-gray-900 text-white">
        <div id="study-option "class="w-[60vw] mb-10 col-start-2 col-end-2 row-start-1 row-end-1">
            <center>
            <button class="bg-white/10 p-5 backdrop-blur-md rounded-md mr-10" onclick="switchmode('block')">Block Mode</button>
            <button class="bg-white/10 p-5 backdrop-blur-md rounded-md mr-10" onclick="switchmode('card')">Study Mode</button>
            <button class="bg-white/10 p-5 backdrop-blur-md rounded-md mr-10" onclick="switchmode('test')">Test Mode</button>
            <button class="bg-white/10 p-5 backdrop-blur-md rounded-md" onclick="shuffletest()">Shuffle Test</button>
            <input type="checkbox" id="shuffle-checkbox" class="ml-10">
            <label for="shuffle-checkbox">Shuffle Cards</label>
            </center>
        </div>
            <button id="prev-button" class="col-start-1 row-start-2 row-end-2 bg-white/10 p-5 backdrop-blur-md rounded-md mr-[5%]" onclick="if (currentmode !== 'test') { currentIndex--; showingFront = true; showCard(currentIndex); } else { showtestquestion(--currentQuestion); }">Prev</button>
            <div id="test" class="relative bg-white/10 rounded-lg border border-white/30 m-10 h-[60vh] w-[60vw] col-start-2 col-end-2 row-start-2 row-end-2">
                <div id="timer" class="pointer-events-none absolute z-10 left-[0px] top-[0px] w-[0%] h-[100%] bg-green-500/10"></div>
                <div class="w-full top-[0px] left-[0px] max-h-[100%] p-6 overflow-y-scroll">
                <progress value="50" max="100" class="top-0px w-full mb-5" id="test-p"></progress>
                <h1 id="q" class="text-4xl">Question</h1>
                <div id="options" class="relative grid grid-cols-2 auto-rows-auto gap-4 mt-6 w-[100%] min-h-[30%] max-h-[70%]">
                    <!-- Options will be populated here -->
                    <div class="bg-white/20 rounded-lg border border-white/30 flex items-center justify-center hover:cursor-pointer">
                        <p>Question1</p>
                    </div>
                    <div class="bg-white/20 rounded-lg border border-white/30 flex items-center justify-center hover:cursor-pointer">
                        <p>Question2</p>
                    </div>
                    <div class="bg-white/20 rounded-lg border border-white/30 flex items-center justify-center hover:cursor-pointer">
                        <p>Question3</p>
                    </div>
                    <div class="bg-white/20 rounded-lg border border-white/30 flex items-center justify-center hover:cursor-pointer">
                        <p>Question4</p>
                    </div>
                </div>
                </div>
            </div>
            <div id="blockframe" style="display: none;" class="relative bg-white/10 rounded-lg border border-white/30 m-10 h-[60vh] w-[60vw] col-start-2 col-end-2 row-start-2 row-end-2">
                <iframe src="/blockblast" id="gameframe" class="w-full h-full">

                </iframe>
            </div>
            <div id="counter" class="absolute right-[2vw] top-1/2 -translate-y-1/2 flex flex-col justify-center gap-8 bg-white/10 backdrop-blur-md rounded-lg border border-white/30 p-8 h-[50vh] w-[12vw] z-20">
                <div class="text-center mt-[5%]">
                    <p class="text-sm uppercase tracking-widest opacity-60">Wrong</p>
                    <p id="wrong" class="text-5xl font-bold text-red-500">0</p>
                </div>

                <hr class="border borer-white w-[98%] mx-auto my-5">
            
                <div class="text-center mt-[5%]">
                    <p class="text-sm uppercase tracking-widest opacity-60">Right</p>
                    <p id="right" class="text-5xl font-bold text-green-500">0</p>
                </div>
            </div>
            <div class="bg-white/10 rounded-lg border border-white/30 m-10 p-6 hover:cursor-pointer h-[60vh] w-[60vw] col-start-2 col-end-2 row-start-2" id="card-container">
                <div id="front">
                <center class="w-[100%] h-[100%]">
                <p id="front-content" class="text-2xl"></p>
                <img id="img" src="" alt="" class="max-h-[70%] max-w-[70%] mt-4">
                </center>
            </div>
            <div id="back">
                <center>
                <p id="back-content" class="text-2xl"></p>
                </center>
            </div>
            <center>
            <p id="progress" class="absolute text-white text-2xl left-[45%] bottom-[25%]"></p>
            </center>
            </div>
            <button id="next-button" class="col-start-3 row-start-2 row-end-2 bg-white/10 p-5 backdrop-blur-md rounded-md ml-[5%]" onclick="if (currentmode !== 'test') { currentIndex++; showingFront = true; showCard(currentIndex); } else { showtestquestion(++currentQuestion); }">Next</button>
    </body> 
</html>
<script>
let block = false
let wrongq = 0;
let rightq = 0; 
let currentmode = '';
switchmode('card')
let currentIndex = 0;
let currentQuestion = 0;
let showingFront = true;
let cardSet = null;
let test = [];
let timerInterval = null;
const game = document.getElementById('gameframe').contentWindow
const par = new URLSearchParams(window.location.search);
const setname = decodeURIComponent(par.get("setname"));
const timerBar = document.getElementById('timer');

const frontDiv = document.getElementById('front');
const backDiv = document.getElementById('back');
const frontContent = document.getElementById('front-content');
const backContent = document.getElementById('back-content');
const cardContainer = document.getElementById('card-container');
const cardImage = document.getElementById('img');

backDiv.style.display = 'none';
let userStats = null;
function resetGame() {
    game.grid = Array(8).fill().map(() => Array(8).fill(null));
    game.score = 0;
    game.scoreDisplay.innerText = "0";
    game.generateNewSet();
}
game.addEventListener('needBlocks', (event) => {
    const scoreAtEmpty = event.detail.currentScore;
    setTimeout(function(){
            block = true
    switchmode('test')
    game.blockBlastGame.generateNewSet()
    }, 500)
    
});
game.addEventListener('gameOver', (event) =>{
    alert('game over')
    resetGame()
})
function moveItem(arr, fromIndex, toIndex) {
    const [item] = arr.splice(fromIndex, 1);
    

    arr.splice(toIndex, 0, item);
    
    return arr;
}
async function fetchAndBuildJSON() {
    const response = await fetch('/api/getstats');
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    
    let result = ''; 
    
    while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        result += decoder.decode(value, { stream: true });
        
        console.log(`Downloaded ${result.length} characters...`);
    }

    const finalObject = JSON.parse(result);
    return finalObject;
}

function updatecount(){
    document.getElementById('wrong').textContent = wrongq
    document.getElementById('right').textContent = rightq
}
function showCard(index, event=false) {
    const shuffle = document.getElementById('shuffle-checkbox').checked;
    if (shuffle && !event) {
        index = Math.floor(Math.random() * cardSet.content.length);
        currentIndex = index;
    }
    if (!cardSet || !cardSet.content || index < 0 || index >= cardSet.content.length) return;
    frontContent.innerHTML = cardSet.content[index].question;
    backContent.innerHTML = cardSet.content[index].answer;
    cardImage.src = cardSet.content[index].image || '';
    frontDiv.style.display = showingFront ? '' : 'none';
    backDiv.style.display = showingFront ? 'none' : '';
    document.getElementById('progress').textContent = `Card ${index + 1} of ${cardSet.content.length}`;
}

cardContainer.addEventListener('click', () => {
    showingFront = !showingFront;
    showCard(currentIndex, event=true);
});

document.addEventListener('keydown', (e) => {
    if (!cardSet) return;
    if (e.key === 'ArrowRight') {
        if (currentIndex < cardSet.content.length - 1) {
            currentIndex++;
            showingFront = true;
            showCard(currentIndex);
        }
    } else if (e.key === 'ArrowLeft') {
        if (currentIndex > 0) {
            currentIndex--;
            showingFront = true;
            showCard(currentIndex);
        }
    }
});

async function getcards(name) {
    userStats = await fetchAndBuildJSON();
    
    await fetch(`/api/cards`)
    .then(response => response.json())
    .then(data => {
        cardSet = data.find(c => c.Title === name);
        if (cardSet && cardSet.content && cardSet.content.length > 0) {
            currentIndex = 0;
            showingFront = true;
            showCard(currentIndex);
            generatetest();
        }
    });
}
function next(){
    if (currentmode !== 'test') { currentIndex++; showingFront = false; showCard(currentIndex); } else { showtestquestion(++currentQuestion); }
}
function switchmode(mode) {
    // 1. Define IDs for each "group"
    const testElements = ['test', 'counter'];
    const cardElements = ['card-container', 'prev-button', 'next-button'];
    const blockElements = ['blockframe'];

    // 2. Logic for 'test' mode
    if (mode === 'test') {
        currentmode = mode;
        // Show test
        testElements.forEach(id => document.getElementById(id).style.display = 'block');
        // Hide others
        cardElements.forEach(id => document.getElementById(id).style.display = 'none');
        blockElements.forEach(id => document.getElementById(id).style.display = 'none');
    }
    
    // 3. Logic for 'block' mode
    else if (mode === 'block') {
        currentmode = mode;
        // Show block
        blockElements.forEach(id => document.getElementById(id).style.display = 'block');
        // Hide others
        testElements.forEach(id => document.getElementById(id).style.display = 'none');
        cardElements.forEach(id => document.getElementById(id).style.display = 'none');
    }
    
    // 4. Logic for default/other mode
    else {
        currentmode = mode;
        // Show cards
        cardElements.forEach(id => document.getElementById(id).style.display = 'block');
        // Hide others
        testElements.forEach(id => document.getElementById(id).style.display = 'none');
        blockElements.forEach(id => document.getElementById(id).style.display = 'none');
    }
}
function generatetest() {
    if (!cardSet || !cardSet.content) return;
    
    test = [];
    let content = cardSet.content;

    content.forEach(data => {
        let wrongOptions = content
            .filter(card => card.answer !== data.answer)
            .map(card => card.answer !== '' ? card.answer : card.image);

        wrongOptions.sort(() => Math.random() - 0.5);
        let options = wrongOptions.slice(0, 3);

        let isHard = false;
        if (userStats && userStats.wrong_questions) {
            const wrongEntry = userStats.wrong_questions.find(q => q.text === data.question);
            if (wrongEntry && wrongEntry.count > 1) isHard = true;
        }

        test.push({
            question: data.question === '' ? data.image : data.question,
            answer: data.answer !== '' ? data.answer : data.image,
            options: options,
            userans: '',
            right: 0,
            isHard: isHard
        });
    });

    shuffletest();
}
function showtestquestion(index){
    if (!test || index < 0 || index >= test.length) return;
    
    currentQuestion = index;
    
    const progress = document.getElementById('test-p');
    progress.setAttribute('value', index);

    const q = test[index];
    const parent = document.getElementById('options');
    const question = document.getElementById('q');

    let alloptions = [...q.options, q.answer];
    alloptions.sort(() => Math.random() - 0.5);

    question.innerHTML = q.question.startsWith('data:image') 
        ? `<img src="${q.question}" class="max-h-[30%] max-w-[30%] mx-auto rounded-lg">` 
        : q.question;

    parent.innerHTML = '';

    // Generate Buttons
    alloptions.forEach(opt => {
        const safeValue = opt.replace(/"/g, '&quot;'); 

        parent.innerHTML += `
            <div 
                data-val="${safeValue}" 
                class="bg-white/20 rounded-lg border border-white/30 flex flex-col items-center justify-center hover:bg-white/30 hover:cursor-pointer p-4 transition-all" 
                onclick="check(this)"
            >
                <div class="pointer-events-none">
                    ${truncateToDetails(opt)}
                </div>
            </div>
        `;
    });
}
function check(ele){
    const allOptions = document.getElementById('options').children;
    for (let child of allOptions) {
        child.classList.remove('border-green-500', 'border-red-500', 'bg-green-500/20', 'bg-red-500/20');
        child.classList.add('border-white/30');
    }

    let selected = ele.getAttribute('data-val');
    let answerq = test[currentQuestion].answer;

    if (selected === answerq) {
        ele.classList.remove('border-white/30');
        ele.classList.add('border-green-500', 'bg-green-500/20');
        const ele2 = document.getElementById('test')
        ele2.classList.remove('bg-white/10')
        ele2.classList.add('bg-green-500/10')
        ele2.classList.remove('border-white/30')
        ele2.classList.add('border-green-500/20')
        const right = document.querySelector('div[data-val="'+ answerq +'"]')
        right.classList.remove('bg-white/10')
        right.classList.add('bg-green-500/30')
        right.classList.remove('border-white/30')
        right.classList.add('border-green-500/20')
        startTimer(2, 'green')
        test[currentQuestion].right++
        test[currentQuestion].userans = 'r'
        rightq++
        if (block){
            switchmode('block')
        }
    } else {
        const ele2 = document.getElementById('test')
        ele2.classList.remove('border-white/30')
        ele2.classList.add('border-red-500/20')
        ele.classList.remove('border-white/30');
        ele.classList.add('border-red-500', 'bg-red-500/20');
        ele2.classList.remove('bg-white/10')
        ele2.classList.add('bg-red-500/10')
        const right = document.querySelector('div[data-val="'+ answerq +'"]')
        right.classList.remove('bg-white/10')
        right.classList.add('bg-green-500/30')
        right.classList.remove('border-white/30')
        right.classList.add('border-green-500/20')
        test[currentQuestion].right--
        test[currentQuestion].userans = 'w'
        shufflehardtoclose(currentQuestion);
        startTimer(2, 'red')
        wrongq++
    }
    updatecount()
}
function startTimer(seconds, color) {
    clearInterval(timerInterval);
    document.getElementById('test').classList.add('pointer-events-none')
    timerBar.style.width = '100%';
    
    timerBar.classList.remove('bg-red-500/10', 'bg-green-500/10'); 
    const colorName = color || 'green';
    timerBar.classList.add(`bg-${colorName}-500/10`);
    
    const totalTime = seconds * 1000; 
    let timeLeft = totalTime;
    const intervalRate = 10; 
    timerInterval = setInterval(() => {
        timeLeft -= intervalRate;
        const percentage = (timeLeft / totalTime) * 100;
        timerBar.style.width = `${percentage}%`;

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            timerBar.style.width = '0%';
            
            showtestquestion(++currentQuestion);
            document.getElementById('test').classList.remove('pointer-events-none')
            const ele2 = document.getElementById('test');
            ele2.classList.remove('border-red-500/20', 'border-green-500/20', 'bg-green-500/10', 'bg-red-500/10');
            ele2.classList.add('border-white/30', 'bg-white/10');
        }
    }, intervalRate);
}

getcards(setname);
function truncateToDetails(text, lineLimit = 3) {
    if (text.startsWith('data:image') || text.startsWith('http')) return text;
    
    const lines = text.split(/<br\s*\/?>/i);
    if (lines.length <= lineLimit) return text;

    const visibleLines = lines.slice(0, lineLimit).join('<br>');
    const hiddenLines = lines.slice(lineLimit).join('<br>');

    return `
        <span>${visibleLines}</span>
        <details class="mt-2 cursor-pointer text-sm text-white/60" onclick="event.stopPropagation()">
            <summary class="hover:text-white text-white">Show More...</summary>
            <div class="mt-1 text-white border-t border-white/10 pt-1">${hiddenLines}</div>
        </details>
    `;
}
function shufflehardtoclose(currentIndex, gap = 2) {
    const recentMistakes = test.filter((q, index) => q.userans === 'w' && index <= currentIndex);

    recentMistakes.forEach(mistake => {
        const reQueue = { ...mistake, userans: '', right: 0 }; 
        
        const insertAt = Math.min(currentIndex + gap + Math.floor(Math.random() * 2), test.length);

        test.splice(insertAt, 0, reQueue);
        
        mistake.userans = 're-queued'; 
    });

    const progress = document.getElementById('test-p');
    progress.setAttribute('max', test.length);
}
function shuffletest() {
    test.sort(() => Math.random() - 0.5);
    test.sort((a, b) => {
        if (a.isHard && !b.isHard) return -1;
        if (!a.isHard && b.isHard) return 1; 
        return 0;
    });

    currentQuestion = 0;
    const progress = document.getElementById('test-p');
    progress.setAttribute('max', test.length);
    showtestquestion(0);
}
window.addEventListener('beforeunload', (event) => {
    let test2 = [];
    test.forEach(function(item) {
        if (item['userans'] !== '' && item['userans'] !== 're-queued') {
            let data = {
                question: item.question.startsWith('data:') ? 'image' : item.question,
                answer: item.answer.startsWith('data:') ? 'image' : item.answer, 
                options: item.options.map(opt => opt.startsWith('data:') ? 'image' : opt),
                userans: item.userans,
                right: item.right,
            };
            test2.push(data);
        }
    });

    if (test2.length > 0 || rightq > 0 || wrongq > 0) {
        const payload = JSON.stringify({
            setname: setname,
            right: rightq, 
            wrong: wrongq,
            test: test2
        });

        const success = navigator.sendBeacon('/api/savetest', new Blob([payload], { type: 'application/json' }));
        
        if (!success) {
            console.error("Beacon failed: Data too large or browser rejected.");
        }
    }
});
</script>
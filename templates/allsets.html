<!DOCTYPE html>
<html class="h-full">
    <head>
        <title>Quiz Cards</title>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gray-900 text-white min-h-screen p-8 font-sans">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-4xl font-bold mb-12 text-white/90 border-l-4 border-indigo-500 pl-6 tracking-tight">
                Available Quiz Sets
            </h1>
            
            <div id="card-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                </div>
        </div>
    </body>
</html>

<script>
document.addEventListener('DOMContentLoaded', () => {
    loadAllGlobalCards();
});

async function loadAllGlobalCards() {
    const grid = document.getElementById('card-grid');
    try {
        // 1. Fetch both the global sets and the user's private library
        const [globalRes, libraryRes] = await Promise.all([
            fetch('/api/allcards?clear=True'),
            fetch('/api/cards?clear=True')
        ]);

        if (!globalRes.ok || !libraryRes.ok) throw new Error('Failed to fetch data');

        const globalDecks = await globalRes.json();
        const userLibrary = await libraryRes.json();

        // 2. Create a Set of titles the user already owns for O(1) lookup
        const ownedTitles = new Set(userLibrary.map(deck => deck.Title));

        grid.innerHTML = '';

        // 3. Filter out decks that are already in the library
        const availableDecks = globalDecks.filter(deck => !ownedTitles.has(deck.Title));

        if (availableDecks.length === 0) {
            grid.innerHTML = `
                <div class="col-span-full text-center p-20 border-2 border-dashed border-white/10 rounded-2xl">
                    <p class="text-white/50 text-xl">You already have all available sets in your library!</p>
                </div>`;
            return;
        }

        availableDecks.forEach(deck => {
            const cardElement = createDeckCard(deck);
            grid.appendChild(cardElement);
        });

    } catch (error) {
        console.error('Error:', error);
        grid.innerHTML = `<p class="col-span-full text-center text-red-400">Error: ${error.message}</p>`;
    }
}

function createDeckCard(deck) {
    const div = document.createElement('div');
    div.className = "group relative flex flex-col bg-white/5 backdrop-blur-md rounded-2xl border border-white/10 p-8 transition-all duration-300 hover:bg-white/10 hover:-translate-y-1 hover:shadow-[0_20px_50px_rgba(0,0,0,0.5)]";
    
    const viewUrl = `/viewcard?user=${encodeURIComponent(deck.name)}&title=${encodeURIComponent(deck.Title)}`;

    div.innerHTML = `
        <div class="flex flex-col h-full">
            <div class="cursor-pointer mb-6" onclick="window.location.href='${viewUrl}'">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-2xl font-bold text-white group-hover:text-indigo-400 transition-colors">
                        ${deck.Title}
                    </h2>
                    <span class="bg-indigo-500/20 text-indigo-300 text-xs px-2 py-1 rounded border border-indigo-500/30">
                        ${deck.cards} Cards
                    </span>
                </div>
                <p class="text-white/60 text-sm leading-relaxed flex-grow mb-6 line-clamp-3">
                    ${deck.description || "No description provided."}
                </p>
            </div>
            
            <div class="mt-auto pt-5 border-t border-white/10">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <span class="block text-[10px] font-bold text-indigo-400 uppercase tracking-[0.2em] mb-1">Created By</span>
                        <span class="text-sm font-medium text-white/80 tracking-wide">${deck.name}</span>
                    </div>
                </div>
                
                <button 
                    onclick="importSet('${deck.Title}', '${deck.name}', this)" 
                    class="w-full py-3 px-4 bg-indigo-600/20 hover:bg-indigo-600/40 border border-indigo-500/30 rounded-xl text-indigo-300 text-sm font-bold transition-all flex items-center justify-center gap-2"
                >
                    <span>ðŸ“¥ Import to Library</span>
                </button>
            </div>
        </div>
        <div class="absolute inset-0 rounded-2xl transition-opacity duration-300 opacity-0 group-hover:opacity-100 pointer-events-none shadow-[inset_0_0_20px_rgba(99,102,241,0.1)]"></div>
    `;
    return div;
}

async function importSet(title, username, btn) {
    const originalContent = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span>âŒ› Importing...</span>`;

    try {
        const res = await fetch(`/api/allcards?user=${encodeURIComponent(username)}&title=${encodeURIComponent(title)}`);
        const data = await res.json();
        if (!data || data.length === 0) throw new Error("Source data not found");
        
        const fullSet = data[0];

        const importRes = await fetch('/import', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(fullSet)
        });

        if (importRes.ok) {
            btn.classList.remove('bg-indigo-600/20', 'text-indigo-300');
            btn.classList.add('bg-green-600/20', 'text-green-300', 'border-green-500/30');
            btn.innerHTML = `<span>âœ… Imported</span>`;
            
            // Optional: Hide the card after a short delay to "clean up" the marketplace
            setTimeout(() => {
                btn.closest('.group').style.opacity = '0';
                setTimeout(() => btn.closest('.group').remove(), 300);
            }, 1000);
        } else {
            throw new Error("Server failed to save set");
        }

    } catch (err) {
        console.error(err);
        alert("Failed to import: " + err.message);
        btn.disabled = false;
        btn.innerHTML = originalContent;
    }
}
</script>